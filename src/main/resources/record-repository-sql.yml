insertRecord: >
  INSERT INTO ${table}
    (expedition_id, local_identifier, data)
  VALUES
    (:expeditionId, :identifier, to_jsonb(:data::jsonb))
  ON CONFLICT (local_identifier, expedition_id)
    DO UPDATE SET data = to_jsonb(:data::jsonb)

insertChildRecord: >
  INSERT INTO ${table}
    (expedition_id, local_identifier, parent_identifier, data)
  VALUES
    (:expeditionId, :identifier, :parent_identifier, to_jsonb(:data::jsonb))
  ON CONFLICT (local_identifier, expedition_id)
    DO UPDATE SET data = to_jsonb(:data::jsonb)

selectEntityIdentifier: >
  SELECT e.project_id AS "projectId", i.expedition_id AS "expeditionId", i.concept_alias AS "conceptAlias"
  FROM entity_identifiers i
    JOIN expeditions e on e.id = i.expedition_id
  WHERE i.identifier = :rootIdentifier

selectRecord: >
  SELECT r.data AS data, e.expedition_code as "expeditionCode", e.project_id as "projectId", '${rootIdentifier}' as "rootIdentifier"
  FROM ${table} AS r
    INNER JOIN expeditions e on r.expedition_id = e.id
  WHERE local_identifier = :localIdentifier AND expedition_id = :expeditionId

selectProjectRecords: >
  SELECT r.data AS data, e.expedition_code as "expeditionCode", e.project_id as "projectId", i.identifier as "rootIdentifier"
  FROM ${table} AS r
    INNER JOIN expeditions e on r.expedition_id = e.id
    INNER JOIN entity_identifiers i on e.id = i.expedition_id and i.concept_alias = :conceptAlias
  WHERE e.project_id = :projectId

selectExpeditionRecords: >
  SELECT r.data AS data, e.expedition_code as "expeditionCode", e.project_id as "projectId", i.identifier as "rootIdentifier"
  FROM ${table} AS r
    INNER JOIN expeditions e on r.expedition_id = e.id
    INNER JOIN entity_identifiers i on e.id = i.expedition_id and i.concept_alias = :conceptAlias
  WHERE e.expedition_code = :expeditionCode AND e.project_id = :projectId

deleteRecords: >
  DELETE
  FROM ${table}
  WHERE expedition_id = :expeditionId and local_identifier not in (:identifiers)

deleteChildRecords: >
  DELETE
  FROM ${table}
  WHERE expedition_id = :expeditionId and (parent_identifier, local_identifier) not in (:identifiers)
